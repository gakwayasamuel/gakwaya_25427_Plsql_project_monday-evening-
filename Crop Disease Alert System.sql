CREATE TABLE FARM (
    farm_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    farm_name VARCHAR2(100) NOT NULL,
    location VARCHAR2(200),
    owner_name VARCHAR2(100)
);

CREATE TABLE CROP (
    crop_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    farm_id NUMBER NOT NULL,
    crop_type VARCHAR2(50) NOT NULL,
    planting_date DATE,
    CONSTRAINT fk_crop_farm FOREIGN KEY (farm_id) REFERENCES FARM(farm_id)
);

CREATE TABLE OBSERVATION (
    obs_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    crop_id NUMBER NOT NULL,
    obs_date DATE NOT NULL,
    symptoms VARCHAR2(4000),
    severity NUMBER CHECK (severity BETWEEN 1 AND 10),
    CONSTRAINT fk_obs_crop FOREIGN KEY (crop_id) REFERENCES CROP(crop_id)
);

CREATE TABLE DISEASE_PATTERN (
    pattern_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    disease_name VARCHAR2(100) NOT NULL,
    symptom_keywords VARCHAR2(1000),
    recommended_action VARCHAR2(1000)
);

CREATE TABLE ALERT (
    alert_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    obs_id NUMBER NOT NULL,
    disease_name VARCHAR2(100) NOT NULL,
    action VARCHAR2(1000),
    alert_date DATE DEFAULT SYSDATE,
    CONSTRAINT fk_alert_obs FOREIGN KEY (obs_id) REFERENCES OBSERVATION(obs_id)
);











-- Insert 5 rows into FARM
INSERT INTO FARM (farm_name, location, owner_name) VALUES ('Green Valley Farm', '123 Farm Lane, Springfield', 'John Doe');
INSERT INTO FARM (farm_name, location, owner_name) VALUES ('Sunny Acres', '456 Country Rd, Shelbyville', 'Jane Smith');
INSERT INTO FARM (farm_name, location, owner_name) VALUES ('Riverbend Farm', '789 River St, Ogdenville', 'Emily Clark');
INSERT INTO FARM (farm_name, location, owner_name) VALUES ('Hilltop Farm', '321 Hill Rd, Capital City', 'Michael Johnson');
INSERT INTO FARM (farm_name, location, owner_name) VALUES ('Maplewood Farm', '654 Maple Ave, North Haverbrook', 'Sarah Lee');

-- Insert 5 rows into CROP (assuming farm_ids 1 to 5)
INSERT INTO CROP (farm_id, crop_type, planting_date) VALUES (1, 'Corn', TO_DATE('2024-04-01', 'YYYY-MM-DD'));
INSERT INTO CROP (farm_id, crop_type, planting_date) VALUES (2, 'Wheat', TO_DATE('2024-03-15', 'YYYY-MM-DD'));
INSERT INTO CROP (farm_id, crop_type, planting_date) VALUES (3, 'Soybean', TO_DATE('2024-04-10', 'YYYY-MM-DD'));
INSERT INTO CROP (farm_id, crop_type, planting_date) VALUES (4, 'Barley', TO_DATE('2024-03-20', 'YYYY-MM-DD'));
INSERT INTO CROP (farm_id, crop_type, planting_date) VALUES (5, 'Rice', TO_DATE('2024-04-05', 'YYYY-MM-DD'));

-- Insert 5 rows into OBSERVATION (assuming crop_ids 1 to 5)
INSERT INTO OBSERVATION (crop_id, obs_date, symptoms, severity) VALUES (1, TO_DATE('2024-05-10', 'YYYY-MM-DD'), 'Yellow spots on leaves', 5);
INSERT INTO OBSERVATION (crop_id, obs_date, symptoms, severity) VALUES (2, TO_DATE('2024-04-25', 'YYYY-MM-DD'), 'Wilting and browning', 7);
INSERT INTO OBSERVATION (crop_id, obs_date, symptoms, severity) VALUES (3, TO_DATE('2024-05-15', 'YYYY-MM-DD'), 'Powdery white coating', 4);
INSERT INTO OBSERVATION (crop_id, obs_date, symptoms, severity) VALUES (4, TO_DATE('2024-05-05', 'YYYY-MM-DD'), 'Stunted growth', 6);
INSERT INTO OBSERVATION (crop_id, obs_date, symptoms, severity) VALUES (5, TO_DATE('2024-05-12', 'YYYY-MM-DD'), 'Leaf curling', 3);

-- Insert 5 rows into DISEASE_PATTERN
INSERT INTO DISEASE_PATTERN (disease_name, symptom_keywords, recommended_action) VALUES ('Leaf Spot', 'yellow spots, leaf spots', 'Apply fungicide and remove affected leaves');
INSERT INTO DISEASE_PATTERN (disease_name, symptom_keywords, recommended_action) VALUES ('Root Rot', 'wilting, browning, root decay', 'Improve drainage and apply fungicide');
INSERT INTO DISEASE_PATTERN (disease_name, symptom_keywords, recommended_action) VALUES ('Powdery Mildew', 'powdery white coating, leaf spots', 'Use sulfur-based treatment and improve air circulation');
INSERT INTO DISEASE_PATTERN (disease_name, symptom_keywords, recommended_action) VALUES ('Dwarfism', 'stunted growth, small leaves', 'Enhance soil nutrients and check for pests');
INSERT INTO DISEASE_PATTERN (disease_name, symptom_keywords, recommended_action) VALUES ('Leaf Curl', 'leaf curling, discoloration', 'Apply insecticide and prune affected areas');

-- Insert 5 rows into ALERT (assuming obs_ids 1 to 5)
INSERT INTO ALERT (obs_id, disease_name, action, alert_date) VALUES (1, 'Leaf Spot', 'Apply fungicide treatment immediately', SYSDATE);
INSERT INTO ALERT (obs_id, disease_name, action, alert_date) VALUES (2, 'Root Rot', 'Improve soil drainage and treat with fungicide', SYSDATE);
INSERT INTO ALERT (obs_id, disease_name, action, alert_date) VALUES (3, 'Powdery Mildew', 'Use sulfur-based fungicide and increase ventilation', SYSDATE);
INSERT INTO ALERT (obs_id, disease_name, action, alert_date) VALUES (4, 'Dwarfism', 'Fertilize soil and monitor for pests', SYSDATE);
INSERT INTO ALERT (obs_id, disease_name, action, alert_date) VALUES (5, 'Leaf Curl', 'Apply insecticide and remove affected leaves', SYSDATE);











-- Package Specification
CREATE OR REPLACE PACKAGE crop_disease_alert_pkg IS

  -- Cursor to get disease patterns matching given symptoms
  CURSOR cur_matching_patterns(p_symptoms VARCHAR2) IS
    SELECT pattern_id, disease_name, recommended_action, symptom_keywords
    FROM DISEASE_PATTERN
    WHERE LOWER(p_symptoms) LIKE '%' || LOWER(symptom_keywords) || '%';

  -- Function to calculate risk level based on severity (1-10)
  FUNCTION calculate_risk_level(p_severity NUMBER) RETURN VARCHAR2;

  -- Procedure to check disease for a given observation and generate alert if matched
  PROCEDURE check_and_alert(p_obs_id NUMBER);

  -- Procedure to manually run disease pattern check for all observations without alerts
  PROCEDURE manual_disease_check;

  -- Procedure to update disease pattern entry
  PROCEDURE update_disease_pattern(
    p_pattern_id       IN DISEASE_PATTERN.pattern_id%TYPE,
    p_disease_name     IN DISEASE_PATTERN.disease_name%TYPE,
    p_symptom_keywords IN DISEASE_PATTERN.symptom_keywords%TYPE,
    p_recommended_action IN DISEASE_PATTERN.recommended_action%TYPE
  );

END crop_disease_alert_pkg;
/


SET SERVEROUTPUT ON;
BEGIN
  -- Test insert and auto alert generation via trigger
  INSERT INTO OBSERVATION (crop_id, obs_date, symptoms, severity)
  VALUES (1, SYSDATE, 'yellow spots on leaves', 7);

  -- Check generated alerts for the last observation
  FOR rec IN (SELECT alert_id, disease_name FROM ALERT WHERE obs_id = (SELECT MAX(obs_id) FROM OBSERVATION)) LOOP
    DBMS_OUTPUT.PUT_LINE('Alert ID: ' || rec.alert_id || ', Disease: ' || rec.disease_name);
  END LOOP;
END;
/

-- Package Specification for farm_management_pkg
CREATE OR REPLACE PACKAGE farm_management_pkg IS

  -- Procedure to add a new farm
  PROCEDURE add_farm(
    p_farm_name  IN FARM.farm_name%TYPE,
    p_location   IN FARM.location%TYPE,
    p_owner_name IN FARM.owner_name%TYPE,
    p_farm_id    OUT FARM.farm_id%TYPE
  );

  -- Procedure to add a new crop to a farm
  PROCEDURE add_crop(
    p_farm_id      IN CROP.farm_id%TYPE,
    p_crop_type    IN CROP.crop_type%TYPE,
    p_planting_date IN CROP.planting_date%TYPE,
    p_crop_id      OUT CROP.crop_id%TYPE
  );

  -- Function to get total number of crops for a given farm
  FUNCTION get_crop_count(p_farm_id IN FARM.farm_id%TYPE) RETURN NUMBER;

END farm_management_pkg;
/

CREATE OR REPLACE PACKAGE BODY farm_management_pkg IS

  PROCEDURE add_farm(
    p_farm_name  IN FARM.farm_name%TYPE,
    p_location   IN FARM.location%TYPE,
    p_owner_name IN FARM.owner_name%TYPE,
    p_farm_id    OUT FARM.farm_id%TYPE
  ) IS
  BEGIN
    INSERT INTO FARM (farm_name, location, owner_name)
    VALUES (p_farm_name, p_location, p_owner_name)
    RETURNING farm_id INTO p_farm_id;
    COMMIT;
  END add_farm;

  PROCEDURE add_crop(
    p_farm_id      IN CROP.farm_id%TYPE,
    p_crop_type    IN CROP.crop_type%TYPE,
    p_planting_date IN CROP.planting_date%TYPE,
    p_crop_id      OUT CROP.crop_id%TYPE
  ) IS
  BEGIN
    INSERT INTO CROP (farm_id, crop_type, planting_date)
    VALUES (p_farm_id, p_crop_type, p_planting_date)
    RETURNING crop_id INTO p_crop_id;
    COMMIT;
  END add_crop;

  FUNCTION get_crop_count(p_farm_id IN FARM.farm_id%TYPE) RETURN NUMBER IS
    v_count NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_count FROM CROP WHERE farm_id = p_farm_id;
    RETURN v_count;
  END get_crop_count;

END farm_management_pkg;
/





SET SERVEROUTPUT ON;
DECLARE
  v_farm_id FARM.farm_id%TYPE;
  v_crop_id CROP.crop_id%TYPE;
  v_crop_count NUMBER;
BEGIN
  -- Add a new farm
  farm_management_pkg.add_farm('Test Farm', 'Test Location', 'Test Owner', v_farm_id);
  DBMS_OUTPUT.PUT_LINE('New Farm ID: ' || v_farm_id);

  -- Add a new crop to the farm
  farm_management_pkg.add_crop(v_farm_id, 'Test Crop', SYSDATE, v_crop_id);
  DBMS_OUTPUT.PUT_LINE('New Crop ID: ' || v_crop_id);

  -- Get number of crops for the farm
  v_crop_count := farm_management_pkg.get_crop_count(v_farm_id);
  DBMS_OUTPUT.PUT_LINE('Total Crops for Farm ID ' || v_farm_id || ': ' || v_crop_count);
END;
/